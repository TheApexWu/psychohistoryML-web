{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/amadeuswoo/Documents/GitHub/psychohistory-web/src/app/api/chat/route.js"],"sourcesContent":["import { readFile } from 'fs/promises';\nimport path from 'path';\n\nconst SYSTEM_PROMPT = `You are a research interface for PsychohistoryML, analyzing 10,000 years of civilizational data from Seshat.\n\nRULE 1 - DISAMBIGUATION FIRST:\nIf the context shows \"[DISAMBIGUATION NEEDED]\", your response MUST list the matching polities with their dates and durations, ask which one they want to explore or offer comparison, and provide NO analysis until they specify. Keep this under 60 words.\n\nRULE 2 - RESPONSE STYLE:\nMaximum 120 words for single-polity responses. Lead with ONE concrete surprising data point. No markdown formatting (no asterisks, no hashtags, use plain dashes for lists). Conversational tone like a sharp colleague. End with ONE question that challenges their assumptions.\n\nRULE 3 - AGONISTIC STANCE:\nYour job is not to deliver answers. Present data, then ask \"Does this match your intuition or break it?\" Never give confident prescriptive takeaways. Acknowledge limits: 256 research polities, CV range 0.51-0.76.\n\nRULE 4 - PROGRESSIVE DEPTH:\nFirst response hooks with one insight plus a question. If they engage, go deeper. Earn the right to info-dump through dialogue.\n\nFINDINGS TO REFERENCE:\nComplexity alone predicts nothing (AUC 0.505). Ancient complexity correlates with SHORTER duration (B=-159). Early Modern complexity correlates with LONGER duration (B=+6). Religion shows 27% feature importance. Warfare variables added 28% AUC improvement. Classical era shows +0.634 moderation effect.`;\n\n/**\n * Compute Euclidean distance between two feature vectors\n */\nfunction euclideanDistance(a, b) {\n  return Math.sqrt(a.reduce((sum, val, i) => sum + Math.pow(val - b[i], 2), 0));\n}\n\n/**\n * Format year for display (handles BCE/CE)\n */\nfunction formatYear(year) {\n  if (year < 0) {\n    return `${Math.abs(year)} BCE`;\n  }\n  return `${year} CE`;\n}\n\n/**\n * Find all polities mentioned in message (case-insensitive substring match)\n * Returns { searchTerm, matches[] }\n */\nfunction findMentionedPolities(message, polities) {\n  const lowerMessage = message.toLowerCase();\n\n  // Common search terms to check (sorted by length descending for greedy matching)\n  const potentialTerms = [];\n\n  // Extract potential polity name fragments from the message\n  for (const polity of polities) {\n    const lowerName = polity.name.toLowerCase();\n    if (lowerMessage.includes(lowerName)) {\n      potentialTerms.push({ term: polity.name, polity });\n    }\n  }\n\n  if (potentialTerms.length === 0) {\n    // Try to find partial matches - look for key civilization words\n    const keywords = ['roman', 'byzantine', 'ottoman', 'mongol', 'han', 'aztec', 'persian', 'spanish', 'french', 'crete', 'egypt', 'china', 'papal', 'venice', 'carolingian', 'merovingian'];\n\n    for (const keyword of keywords) {\n      if (lowerMessage.includes(keyword)) {\n        const matches = polities.filter(p => p.name.toLowerCase().includes(keyword));\n        if (matches.length > 0) {\n          return { searchTerm: keyword, matches };\n        }\n      }\n    }\n\n    return { searchTerm: null, matches: [] };\n  }\n\n  // Find the longest matching term (most specific)\n  potentialTerms.sort((a, b) => b.term.length - a.term.length);\n  const primaryTerm = potentialTerms[0].term.toLowerCase();\n\n  // Now find ALL polities that contain this term\n  const allMatches = polities.filter(p =>\n    p.name.toLowerCase().includes(primaryTerm)\n  );\n\n  return { searchTerm: potentialTerms[0].term, matches: allMatches };\n}\n\n/**\n * Find k most similar polities using Euclidean distance on features array\n */\nfunction findSimilarPolities(targetPolity, polities, k = 3) {\n  const withDistance = polities\n    .filter(p => p.id !== targetPolity.id)\n    .map(p => ({\n      ...p,\n      distance: euclideanDistance(targetPolity.features, p.features)\n    }));\n\n  withDistance.sort((a, b) => a.distance - b.distance);\n  return withDistance.slice(0, k);\n}\n\n/**\n * Build enriched message with polity context or disambiguation request\n */\nfunction buildEnrichedMessage(originalMessage, searchTerm, matches, polities) {\n  if (matches.length === 0) {\n    return originalMessage;\n  }\n\n  // DISAMBIGUATION: Multiple matches found\n  if (matches.length > 1) {\n    const matchList = matches\n      .map(p => `- ${p.name} | ${formatYear(p.start)} to ${formatYear(p.end)} | ${p.duration} years | ${p.era}`)\n      .join('\\n');\n\n    return `[DISAMBIGUATION NEEDED]\nUser mentioned: \"${searchTerm}\"\nMultiple polities found:\n${matchList}\n\nAsk the user which specific polity they want to explore, or offer to compare them.\nDo NOT analyze yet - clarify first.\n\nUser question: ${originalMessage}`;\n  }\n\n  // SINGLE MATCH: Provide full context\n  const polity = matches[0];\n  const similarPolities = findSimilarPolities(polity, polities, 3);\n\n  const rf = polity.rawFeatures;\n  const militaryScore = ((rf.weapons || 0) + (rf.armor || 0) + (rf.cavalry || 0) + (rf.fortifications || 0)) / 4;\n\n  const similarStr = similarPolities\n    .map(p => `- ${p.name}: ${p.era}, ${p.duration} years`)\n    .join('\\n');\n\n  return `[POLITY DATA]\n${polity.name} | ${polity.era} | ${formatYear(polity.start)} to ${formatYear(polity.end)} (${polity.duration} years)\nRegion: ${polity.region}\nFeatures: hierarchy ${rf.hierarchy}, government ${rf.government}, military ${militaryScore.toFixed(1)}, religion ${rf.religion}\n\nSimilar polities:\n${similarStr}\n\nUser question: ${originalMessage}`;\n}\n\n// Cache polities data to avoid re-reading on every request\nlet polities = null;\n\nasync function loadPolities() {\n  if (polities) return polities;\n\n  const filePath = path.join(process.cwd(), 'public', 'data', 'polities.json');\n  const data = await readFile(filePath, 'utf-8');\n  polities = JSON.parse(data);\n  return polities;\n}\n\nexport async function POST(request) {\n  // Check for API key\n  if (!process.env.ANTHROPIC_API_KEY) {\n    return Response.json(\n      { error: 'ANTHROPIC_API_KEY environment variable is not set' },\n      { status: 500 }\n    );\n  }\n\n  // Parse request body\n  let body;\n  try {\n    body = await request.json();\n  } catch {\n    return Response.json(\n      { error: 'Invalid JSON in request body' },\n      { status: 400 }\n    );\n  }\n\n  const { message, history = [] } = body;\n\n  if (!message || typeof message !== 'string') {\n    return Response.json(\n      { error: 'Message is required and must be a string' },\n      { status: 400 }\n    );\n  }\n\n  // Load polities data\n  let politiesData;\n  try {\n    politiesData = await loadPolities();\n  } catch (err) {\n    return Response.json(\n      { error: 'Failed to load polities data: ' + err.message },\n      { status: 500 }\n    );\n  }\n\n  // Detect polity mentions (may return multiple matches)\n  const { searchTerm, matches } = findMentionedPolities(message, politiesData);\n\n  // Build enriched message with context or disambiguation\n  const enrichedMessage = buildEnrichedMessage(message, searchTerm, matches, politiesData);\n\n  // Build messages array for Claude API\n  const messages = [\n    ...history,\n    { role: 'user', content: enrichedMessage }\n  ];\n\n  // Call Anthropic Claude API\n  try {\n    const response = await fetch('https://api.anthropic.com/v1/messages', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': process.env.ANTHROPIC_API_KEY,\n        'anthropic-version': '2023-06-01'\n      },\n      body: JSON.stringify({\n        model: 'claude-sonnet-4-20250514',\n        max_tokens: 1024,\n        system: SYSTEM_PROMPT,\n        messages\n      })\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      return Response.json(\n        { error: 'Claude API error: ' + (errorData.error?.message || response.statusText) },\n        { status: response.status }\n      );\n    }\n\n    const data = await response.json();\n    const assistantMessage = data.content?.[0]?.text || '';\n\n    return Response.json({ response: assistantMessage });\n\n  } catch (err) {\n    return Response.json(\n      { error: 'Failed to call Claude API: ' + err.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}